stages:
  - build
  - test
  - deploy

build_job:
  stage: build
  variables:
    IIS_VERSION_SUFFIX: $CI_PIPELINE_ID
  script:
    - export IIS_SOURCE_REVISION_ID=`git describe --always --tags --dirty`
    - dotnet publish src/Iis.Api/Iis.Api.csproj -c Release -o publish/core
    - env
  artifacts:
    paths:
      - publish
    expire_in: 1 month

  tags:
    - ci
  only:
    - master
    - /^v.+$/
    - /^sprint\..+$/
    - /^Release_*/

unit_test:
  stage: test
  script:
    - dotnet test --logger:"junit;LogFilePath=../../{assembly}-test-result.xml;MethodFormat=Class;FailureBodyFormat=Verbose" src/Iis.UnitTests/Iis.UnitTests.csproj
  artifacts:
    when: always
    paths:
      - ./*test-result.xml
    reports:
      junit:
        - ./*test-result.xml
 tags:
   - ci


.deploy:
  stage: deploy
  variables:
    GIT_STRATEGY: none
    GIT_CHECKOUT: "false"
    EXTRA_VARS: "artifacts_path=$CI_PROJECT_DIR"
  script:
    - cd /home/gitlab-runner/ansible
    - echo "Deploying IIS API using ./vars/$DEPLOYMENT_FILE and extra-vars='$EXTRA_VARS'"
    - ansible-playbook app_api_net.yml -e "@./vars/$DEPLOYMENT_FILE" -e "$EXTRA_VARS"
    - rm -rf $CI_PROJECT_DIR/*
  tags:
    - ansible
  only:
    - /^v.+$/
    - /^sprint\..+$/
    - /^Release_*/
    - master

.deploy_contour_dev:
  extends: .deploy
  variables:
    DEPLOYMENT_FILE: dev_con.yml
  environment:
    name: dev_contour
    url: http://contour-dev-01.contour.net

.deploy_od_dev:
  extends: .deploy
  variables:
    DEPLOYMENT_FILE: dev_od.yml
  environment:
    name: dev_odysseus
    url: http://od-dev.contour.net


deploy_contour_dev_auto:
  extends: .deploy_contour_dev
  only:
    - /^Release_*/
    - master

deploy_od_dev:
  extends: .deploy_od_dev
  only:
    - /^Release_*/
    - master

deploy_contour_dev_manual:
  extends: .deploy_contour_dev
  when: manual

deploy_od_dev_manual:
  extends: .deploy_od_dev
  when: manual


deploy_contour_qa:
  extends: .deploy
  variables:
    DEPLOYMENT_FILE: qa_con.yml
##    EXTRA_VARS: "tag_name=$CI_COMMIT_TAG ontology_clear='$ONTOLOGY_CLEAR'"
  environment:
    name: qa_contour
    url: http://qa-app.contour.net
  when: manual


deploy_od_qa:
  extends: .deploy
  variables:
    DEPLOYMENT_FILE: qa_od.yml
##    EXTRA_VARS: "tag_name=$CI_COMMIT_TAG ontology_clear='$ONTOLOGY_CLEAR'"
  environment:
    name: qa_odysseus
    url: http://qa-app.odysseus.lcl
  when: manual
